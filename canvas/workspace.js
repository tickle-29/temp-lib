"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Workspace=void 0;const react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),page_1=__importDefault(require("./page")),rules_1=require("./rules"),hotkeys_1=require("./hotkeys"),l10n_1=require("../utils/l10n"),limit=(e,t,r)=>Math.max(t,Math.min(r,e)),ZERO_SIZE_WARNING="Polotno warning: <Workspace /> component can not automatically detect its size.\nWidth or height of parent elements is equal 0.\nPlease make sure it has non-zero size. You may need to adjust it with your styles. <Workspace /> will automatically fit into parent container.\nFor simpler debugging here is the log of the parent element:",useSaveScrollOnScaleChange=(e,t,r,a,l,n)=>{const o=react_1.default.useRef({width:t,height:r}),c=react_1.default.useRef({top:0,left:0}),s=react_1.default.useRef(!1),i=react_1.default.useRef(l.pages.length);s.current=i.current!==l.pages.length,i.current=l.pages.length,react_1.default.useEffect((()=>{const t=e.current,r=e=>{c.current={top:t.scrollTop,left:t.scrollLeft}};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]),react_1.default.useLayoutEffect((()=>{if(!e.current)return;if(s.current)return;const a=e.current,l=(c.current.left+a.offsetWidth/2)/o.current.width,i=(c.current.top+a.offsetHeight/2)/o.current.height;n.current=!0,a.scrollLeft=l*t-a.offsetWidth/2,a.scrollTop=i*r-a.offsetHeight/2,o.current={width:t,height:r}}),[a,t,r])},useScrollOnActiveChange=(e,t,r,a,l)=>{const n=react_1.default.useRef(!1),o=react_1.default.useRef(null);react_1.default.useEffect((()=>{const t=e.current,r=()=>{l.current};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]);const c=r.pages.indexOf(r.activePage);react_1.default.useLayoutEffect((()=>{if(!r.activePage)return;if(!e.current)return;if(n.current)return;const a=e.current,o=r.pages.indexOf(r.activePage)*t;Math.abs(o-a.scrollTop)>.9*t&&(l.current=!0,a.scrollTop=o)}),[r.activePage,c]);return{handleScroll:e=>{if(l.current)return void(l.current=!1);n.current=!0,clearTimeout(o.current),o.current=setTimeout((()=>{n.current=!1}),300);const t=e.currentTarget.childNodes[0].offsetHeight,c=e.currentTarget.scrollTop,s=Math.floor((c+a.height/3)/t),i=r.pages[s];i&&i.select()}}},NoPages=({store:e})=>react_1.default.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center"}},react_1.default.createElement("p",null,(0,l10n_1.t)("workspace.noPages")),react_1.default.createElement("button",{onClick:()=>{e.addPage()}},(0,l10n_1.t)("workspace.addPage")));exports.Workspace=(0,mobx_react_lite_1.observer)((({store:e,pageControlsEnabled:t,backgroundColor:r,pageBorderColor:a,activePageBorderColor:l,bleedColor:n,components:o})=>{const[c,s]=react_1.default.useState({width:100,height:100}),i=react_1.default.useRef(c),u=react_1.default.useRef(null),d=react_1.default.useRef(null),h=e.bleedVisible?Math.max(0,...e.pages.map((e=>e.bleed))):0,f=Math.max(...e.pages.map((e=>e.computedWidth))),g=Math.max(...e.pages.map((e=>e.computedHeight))),p=f+2*h,_=g+2*h,m=()=>{if(null===u.current)return;const t=u.current.getBoundingClientRect();0!==t.width&&0!==t.height||(console.warn(ZERO_SIZE_WARNING),console.log(u.current));const r=d.current.clientWidth||t.width,a={width:r,height:t.height};(i.current.width!==a.width||i.current.height!==a.height)&&(s(a),i.current=a);const l=(r-40)/p,n=(t.height-110)/_,o=Math.max(Math.min(l,n),.01);e.scaleToFit!==o&&(e.setScale(o),e._setScaleToFit(o))};react_1.default.useEffect(m,[p,_]),react_1.default.useEffect((()=>{const e=u.current;if(window.ResizeObserver){const t=new ResizeObserver(m);return t.observe(e),()=>t.unobserve(e)}{const e=setInterval(m,100);return()=>clearInterval(e)}}),[p,_]);const v=Math.max(20,(c.width-p*e.scale)/2),w=_*e.scale*e.pages.length,b=Math.max(55,(c.height-w)/e.pages.length/2);react_1.default.useEffect((()=>{const t=t=>{(0,hotkeys_1.handleHotkey)(t,e)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)}),[]),react_1.default.useEffect((()=>{var t;const r=t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();const n=Math.max(2,e.scaleToFit),o=Math.min(.5,e.scaleToFit),c=(r=t.deltaY<0?1.05*e.scale:e.scale/1.05,a=o,l=n,Math.max(a,Math.min(l,r)));e.setScale(c)}else var r,a,l};return null===(t=d.current)||void 0===t||t.addEventListener("wheel",r),()=>{var e;return null===(e=d.current)||void 0===e?void 0:e.removeEventListener("wheel",r)}}),[]);const x=react_1.default.useRef(!1);useSaveScrollOnScaleChange(d,p*e.scale+2*v,_*e.scale+2*b,e.scale,e,x);const{handleScroll:E}=useScrollOnActiveChange(d,_*e.scale+2*b,e,c,x),y=c.width>=p*e.scale+2*v,k=r||"rgba(232, 232, 232, 0.9)",P=e.pages.indexOf(e.activePage),C=(null==o?void 0:o.NoPages)||NoPages;return react_1.default.createElement("div",{ref:u,style:{width:"100%",height:"100%",position:"relative",outline:"none",flex:1,backgroundColor:k},tabIndex:0,className:"polotno-workspace-container"},react_1.default.createElement("div",{ref:d,onScroll:E,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"auto",overflowX:y?"hidden":"auto"},className:"polotno-workspace-inner"},e.pages.map(((r,c)=>Math.abs(c-P)<=1||r._exporting?react_1.default.createElement(page_1.default,{key:r.id,page:r,xPadding:v,yPadding:b,width:p*e.scale+2*v,height:_*e.scale+2*b,store:e,pageControlsEnabled:t,backColor:k,pageBorderColor:a||"lightgrey",activePageBorderColor:l||"rgb(0, 161, 255)",bleedColor:n||"rgba(255, 0, 0, 0.1)",components:o}):react_1.default.createElement("div",{key:r.id,style:{width:p*e.scale+2*v+"px",height:_*e.scale+2*b+"px",backgroundColor:k,paddingLeft:v+"px",paddingRight:v+"px",paddingTop:b+"px",paddingBottom:b+"px"}},react_1.default.createElement("div",{style:{width:" 100%",height:"100%",backgroundColor:"white"}})))),e.rulesVisible&&react_1.default.createElement(rules_1.TopRules,{store:e,xPadding:v,yPadding:b,width:p*e.scale+2*v,height:_*e.scale+2*b}),0===e.pages.length&&react_1.default.createElement(C,{store:e})))})),exports.default=exports.Workspace;