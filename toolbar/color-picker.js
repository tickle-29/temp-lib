"use strict";var __rest=this&&this.__rest||function(e,t){var r={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(r[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(r[a[o]]=e[a[o]])}return r},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ColorPicker=void 0;const react_1=__importDefault(require("react")),popover2_1=require("@blueprintjs/popover2"),core_1=require("@blueprintjs/core"),core_2=require("@blueprintjs/core"),react_color_1=require("react-color"),styled_1=__importDefault(require("../utils/styled")),gradient_1=require("../utils/gradient"),svg_1=require("../utils/svg"),DEFAULT_COLORS=["#D0021B","#F5A623","#F8E71C","#8B572A","#7ED321","#417505","#BD10E0","#9013FE","#4A90E2","#50E3C2","#B8E986","#000000","#4A4A4A","#9B9B9B","#FFFFFF"].reverse(),getUsedColors=e=>{const t=[];e.pages.forEach((e=>{e.children.forEach((e=>{"text"===e.type&&t.push(e.fill),"svg"===e.type&&t.push(...e.colorsReplace.values())}))}));const r=[];return t.forEach((e=>{if((0,gradient_1.isGradient)(e)){const{stops:t}=(0,gradient_1.parseColor)(e);r.push(...t.map((e=>e.color)))}else r.push(e)})),[...new Set(r)]},SolidContainer=(0,styled_1.default)("div")`
  & .sketch-picker {
    padding: 0px !important;
    box-shadow: none !important;
    background: none !important;
  }

  & .flexbox-fix {
    border-top: none !important;
  }

  .bp4-dark & .sketch-picker {
    background-color: #394b59;
  }

  .bp4-dark & .sketch-picker label {
    color: #f5f8fa !important;
  }
`,SolidInput=e=>{var{style:t,color:r,onChange:a}=e,o=__rest(e,["style","color","onChange"]);const[n,l]=react_1.default.useState(r);react_1.default.useEffect((()=>{l(r)}),[r]);const i=react_1.default.useRef(),c=react_1.default.useRef();return react_1.default.createElement(SolidContainer,{style:t,onMouseDown:e=>{"INPUT"!==e.target.tagName&&e.preventDefault()}},react_1.default.createElement(react_color_1.SketchPicker,Object.assign({color:n},o,{onChange:e=>{const{r:t,g:r,b:o,a:n}=e.rgb,s=`rgba(${t},${r},${o},${n})`;l(s),c.current=s,i.current||(i.current=window.setTimeout((()=>{i.current=0,a(s)}),50))}})))},serializeStops=e=>e.map((e=>`${e.color} ${100*e.offset}%`)).join(","),LinearGradient=({value:e,onChange:t,store:r})=>{const{rotation:a,stops:o}=(0,gradient_1.parseColor)(e),n=react_1.default.useRef(o);n.current=o;const l=react_1.default.useRef(a);l.current=a;const[i,c]=react_1.default.useState(0),s=react_1.default.useRef(null),d=react_1.default.useRef(!1),u=()=>{d.current=!0};return react_1.default.useEffect((()=>{const e=e=>{if(d.current){const r=s.current.getBoundingClientRect(),a=e.clientX-r.left,u=a/r.width,p=u<-.5||u>1.5;if(o.length>2&&p)return c(0),d.current=!1,n.current.splice(i,1),void t(`linear-gradient(${l.current}deg, ${serializeStops(n.current)})`);const f=Math.min(1,Math.max(0,a/r.width)),g=[...n.current];g[i].offset=f,t(`linear-gradient(${l.current}deg, ${serializeStops(g)})`)}},r=()=>{d.current=!1};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",r),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",r)}}),[i,n]),react_1.default.createElement("div",null,react_1.default.createElement("div",{style:{width:"calc(100% - 35px)",height:"60px",position:"relative"}},react_1.default.createElement("div",{ref:s,style:{position:"absolute",top:0,left:0,width:"100%",marginLeft:"15px",height:"100%",zIndex:0},onMouseDown:e=>{const r=e.currentTarget.getBoundingClientRect(),n=e.clientX-r.left,l=Math.min(1,Math.max(0,n/r.width)),i=o[0].color;o.push({color:i,offset:l}),o.sort(((e,t)=>e.offset-t.offset));const s=o.findIndex((e=>e.offset===l));c(s),u(),t(`linear-gradient(${a}deg, ${serializeStops(o)})`)}}),o.map((({offset:e,color:t},r)=>react_1.default.createElement("div",{key:r,style:{position:"absolute",top:"10px",left:100*e+"%",border:r===i?"2px solid rgb(0, 161, 255)":"2px solid rgb(0, 0, 0, 0)",padding:"2px"},onMouseDown:e=>{e.stopPropagation(),c(r),u()}},react_1.default.createElement(ColoredBox,{background:t,style:{margin:0}}))))),react_1.default.createElement("div",{style:{width:"calc(100% - 30px)",height:"10px",marginLeft:"15px",background:`linear-gradient(90deg,${serializeStops(o)})`}}),react_1.default.createElement("div",{style:{padding:"10px"}},react_1.default.createElement(core_2.Slider,{min:0,max:360,value:a,showTrackFill:!1,labelRenderer:!1,onChange:e=>{t(`linear-gradient(${e}deg,${serializeStops(o)})`)}})),react_1.default.createElement(SolidInput,{color:o[i].color,onChange:e=>{const r=[...o];r[i].color=e,t(`linear-gradient(${a}deg, ${serializeStops(r)})`)}}))},VariantColorInput=({value:e,onChange:t,preset:r,store:a})=>{const[o,n]=react_1.default.useState((0,gradient_1.isGradient)(e)?"gradient":"solid");return react_1.default.createElement("div",{style:{padding:"5px"}},react_1.default.createElement(core_1.Tabs,{id:"TabsExample",selectedTabId:o,onChange:e=>n(e)},react_1.default.createElement(core_1.Tab,{id:"solid",title:"Solid",panel:react_1.default.createElement(SolidInput,{color:e,onChange:t,presetColors:r,style:{padding:"0"}})}),react_1.default.createElement(core_1.Tab,{id:"gradient",title:"Linear",panel:react_1.default.createElement(LinearGradient,{value:e,onChange:t,store:a}),panelClassName:"ember-panel"})))},ColoredBox=e=>{var{size:t=30,background:r,style:a={},children:o=null}=e,n=__rest(e,["size","background","style","children"]);return react_1.default.createElement("div",Object.assign({onMouseDown:e=>e.preventDefault(),style:Object.assign({width:t+"px",height:t+"px",background:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='15' viewBox='0 0 8 8'%3E%3Cg fill='rgba(112, 112, 116, 1)' fill-opacity='1'%3E%3Cpath fill-rule='evenodd' d='M0 0h4v4H0V0zm4 4h4v4H4V4z'/%3E%3C/g%3E%3C/svg%3E\")",borderRadius:"2px",boxShadow:"0 0 2px grey",marginBottom:"-4px"},a)},n),react_1.default.createElement("div",{style:{width:t+"px",height:t+"px",background:r}},o))},ColorPicker=({value:e,onChange:t,size:r,store:a,gradientEnabled:o,children:n,style:l})=>{const i=(a?getUsedColors(a).slice(0,8):[]).filter((e=>!DEFAULT_COLORS.find((t=>(0,svg_1.sameColors)(t,e))))),c=i.concat(DEFAULT_COLORS.slice(0,16-i.length).reverse());return react_1.default.createElement(popover2_1.Popover2,{autoFocus:!1,enforceFocus:!0,interactionKind:"click",hasBackdrop:!0,content:o?react_1.default.createElement(VariantColorInput,{preset:c,value:e,onChange:t,store:a}):react_1.default.createElement("div",{style:{padding:"5px"}},react_1.default.createElement(SolidInput,{color:e,onChange:t,presetColors:c}))},react_1.default.createElement(ColoredBox,{size:r,background:e,style:l},n))};exports.ColorPicker=ColorPicker,exports.default=exports.ColorPicker;