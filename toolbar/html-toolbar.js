"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.HtmlToolbar=exports.DirectionInput=exports.SpacingInput=exports.FontColorInput=exports.FontStyleGroup=exports.FontSizeInput=exports.FontFamilyInput=void 0;const react_1=__importDefault(require("react")),mobx_react_lite_1=require("mobx-react-lite"),core_1=require("@blueprintjs/core"),popover2_1=require("@blueprintjs/popover2"),react_window_1=require("react-window"),swr_1=__importDefault(require("swr")),fonts_1=require("../utils/fonts"),api_1=require("../utils/api"),use_api_1=require("../utils/use-api"),element_container_1=require("./element-container"),color_picker_1=__importDefault(require("./color-picker")),filters_picker_1=__importDefault(require("./filters-picker")),MdcFormatLineSpacing_1=__importDefault(require("@meronex/icons/mdc/MdcFormatLineSpacing")),MdFormatTextdirectionRToL_1=__importDefault(require("@meronex/icons/md/MdFormatTextdirectionRToL")),MdFormatTextdirectionLToR_1=__importDefault(require("@meronex/icons/md/MdFormatTextdirectionLToR")),styled_1=__importDefault(require("../utils/styled")),MdcFormatVerticalAlignTop_1=__importDefault(require("@meronex/icons/mdc/MdcFormatVerticalAlignTop")),MdcFormatVerticalAlignCenter_1=__importDefault(require("@meronex/icons/mdc/MdcFormatVerticalAlignCenter")),MdcFormatVerticalAlignBottom_1=__importDefault(require("@meronex/icons/mdc/MdcFormatVerticalAlignBottom")),flags_1=require("../utils/flags"),html_element_1=require("../canvas/html-element"),Image=(0,styled_1.default)("img")`
  height: 20px;

  .bp4-dark & {
    filter: invert(1);
  }
`,googleFonts=(0,fonts_1.getFontsList)(),FontItem=({fontFamily:e,handleClick:t,modifiers:n,store:l,isCustom:o})=>{react_1.default.useEffect((()=>{o&&l.loadFont(e)}),[e,o]);const r=o?e:react_1.default.createElement(Image,{src:(0,api_1.getGoogleFontImage)(e)});return react_1.default.createElement(core_1.MenuItem,{text:r,active:n.active,disabled:n.disabled,onClick:t,style:{fontFamily:'"'+e+'"'}})},SearchInput=({onChange:e,defaultValue:t})=>{const n=react_1.default.useRef(null);return react_1.default.useEffect((()=>{n.current&&n.current.focus()}),[]),react_1.default.createElement(core_1.InputGroup,{leftIcon:"search",inputRef:n,defaultValue:t,onChange:t=>e(t.target.value)})},FontMenu=({store:e,fonts:t,activeFont:n,activeFontLabel:l,onFontSelect:o})=>{const[r,i]=react_1.default.useState(""),a=t.filter((e=>e.toLowerCase().indexOf(r.toLowerCase())>=0));return react_1.default.createElement(popover2_1.Popover2,{content:react_1.default.createElement("div",null,react_1.default.createElement(SearchInput,{onChange:e=>i(e),defaultValue:r}),react_1.default.createElement("div",{style:{paddingTop:"5px"}},react_1.default.createElement(react_window_1.FixedSizeList,{innerElementType:react_1.default.forwardRef(((e,t)=>react_1.default.createElement(core_1.Menu,Object.assign({ref:t},e)))),height:Math.min(400,30*a.length)+10,width:210,itemCount:a.length,itemSize:30,children:({index:t,style:l})=>{const r=a[t];return react_1.default.createElement("div",{style:l},react_1.default.createElement(FontItem,{key:r,fontFamily:r,modifiers:{active:n===r},handleClick:()=>o(r),store:e,isCustom:e.fonts.find((e=>e.fontFamily===r))||fonts_1.globalFonts.find((e=>e.fontFamily===r))}))}})))},react_1.default.createElement(core_1.Button,{text:l,rightIcon:"caret-down",minimal:!0,style:{marginRight:"5px",fontFamily:'"'+n+'"',overflow:"hidden",whiteSpace:"nowrap",maxHeight:"30px"}}))};exports.FontFamilyInput=(0,mobx_react_lite_1.observer)((({element:e,store:t})=>{const{data:n,mutate:l}=(0,swr_1.default)((0,api_1.getGoogleFontsListAPI)(),use_api_1.fetcher,{isPaused:()=>(0,fonts_1.isGoogleFontChanged)(),fallbackData:[]});react_1.default.useEffect((()=>{l()}),[(0,fonts_1.isGoogleFontChanged)()]);const o=t.fonts.concat(fonts_1.globalFonts).map((e=>e.fontFamily)).concat((null==n?void 0:n.length)?n:googleFonts);let r=e.fontFamily;return r.length>15&&(r=e.fontFamily.slice(0,15)+"..."),react_1.default.createElement(FontMenu,{fonts:o,activeFont:e.fontFamily,activeFontLabel:r,store:t,onFontSelect:t=>{e.set({fontFamily:t})}})})),exports.FontSizeInput=(0,mobx_react_lite_1.observer)((({element:e})=>react_1.default.createElement(core_1.NumericInput,{onValueChange:t=>{e.set({fontSize:t})},value:Math.round(e.fontSize),style:{width:"50px"},min:5})));const ALIGN_OPTIONS=["left","center","right","justify"],VERTICAL_ALIGN_OPTIONS=["top","middle","bottom"],VERTICAL_ALIGN_ICONS={top:react_1.default.createElement(MdcFormatVerticalAlignTop_1.default,null),middle:react_1.default.createElement(MdcFormatVerticalAlignCenter_1.default,null),bottom:react_1.default.createElement(MdcFormatVerticalAlignBottom_1.default,null)};exports.FontStyleGroup=(0,mobx_react_lite_1.observer)((({element:e,store:t})=>react_1.default.createElement(core_1.ButtonGroup,null,react_1.default.createElement(core_1.Button,{minimal:!0,icon:"align-"+e.align,onClick:()=>{const t=(ALIGN_OPTIONS.indexOf(e.align)+1+ALIGN_OPTIONS.length)%ALIGN_OPTIONS.length,n=ALIGN_OPTIONS[t];e.set({align:n})}}),flags_1.flags.textVerticalResizeEnabled&&react_1.default.createElement(core_1.Button,{minimal:!0,icon:VERTICAL_ALIGN_ICONS[e.verticalAlign],onClick:()=>{const n=(VERTICAL_ALIGN_OPTIONS.indexOf(e.verticalAlign)+1+VERTICAL_ALIGN_OPTIONS.length)%VERTICAL_ALIGN_OPTIONS.length,l=VERTICAL_ALIGN_OPTIONS[n];t.history.transaction((()=>{e.set({verticalAlign:l})}))}}),react_1.default.createElement(core_1.Button,{minimal:!0,icon:"bold",active:html_element_1.quillRef.currentFormat.bold||"bold"===e.fontWeight||"700"===e.fontWeight,onMouseDown:e=>{e.preventDefault()},onClick:t=>{const n=window.__polotnoQuill;if(n){const e=n.getSelection();return void n.formatText(e.index,e.length,"bold",!html_element_1.quillRef.currentFormat.bold,"user")}"bold"===e.fontWeight||"700"===e.fontWeight?e.set({fontWeight:"normal"}):e.set({fontWeight:"bold"})}}),react_1.default.createElement(core_1.Button,{minimal:!0,icon:"italic",onMouseDown:e=>{e.preventDefault()},active:html_element_1.quillRef.currentFormat.italic||"italic"===e.fontStyle,onClick:()=>{const t=window.__polotnoQuill;if(t){const e=t.getSelection();t.formatText(e.index,e.length,"italic",!html_element_1.quillRef.currentFormat.italic,"user")}else"italic"===e.fontStyle?e.set({fontStyle:"normal"}):e.set({fontStyle:"italic"})}}),react_1.default.createElement(core_1.Button,{minimal:!0,icon:"underline",active:html_element_1.quillRef.currentFormat.underline||e.textDecoration.indexOf("underline")>=0,onMouseDown:e=>{e.preventDefault()},onClick:()=>{const t=window.__polotnoQuill;if(t){const e=t.getSelection();return void t.formatText(e.index,e.length,"underline",!html_element_1.quillRef.currentFormat.underline,"user")}let n=e.textDecoration.split(" ");n.indexOf("underline")>=0?n=n.filter((e=>"underline"!==e)):n.push("underline"),e.set({textDecoration:n.join(" ")})}})))),exports.FontColorInput=(0,mobx_react_lite_1.observer)((({element:e,store:t})=>react_1.default.createElement(color_picker_1.default,{value:html_element_1.quillRef.currentFormat.color||e.fill,onChange:t=>{const n=window.__polotnoQuill,l=null==n?void 0:n.getSelection(),o=(null==l?void 0:l.length)>=(null==n?void 0:n.getLength())-1;if(n&&!o&&(null==l?void 0:l.length))n.formatText(l.index,l.length,"color",t,"user");else{var r=e.text.replace(/style=".*?"/g,"");e.set({fill:t,text:r})}},store:t}))),exports.SpacingInput=(0,mobx_react_lite_1.observer)((({element:e})=>react_1.default.createElement(popover2_1.Popover2,{content:react_1.default.createElement("div",{style:{padding:"15px 25px",width:"200px"}},react_1.default.createElement("p",null,"Line height"),react_1.default.createElement(core_1.Slider,{value:"number"==typeof e.lineHeight?100*e.lineHeight:120,labelStepSize:50,onChange:t=>{e.set({lineHeight:t/100})},min:50,max:250,stepSize:10,showTrackFill:!0}),react_1.default.createElement("p",null,"Letter spacing"),react_1.default.createElement(core_1.Slider,{value:100*e.letterSpacing,labelStepSize:50,onChange:t=>{e.set({letterSpacing:t/100})},min:-50,max:250,stepSize:10,showTrackFill:!1})),position:core_1.Position.BOTTOM},react_1.default.createElement(core_1.Button,{icon:react_1.default.createElement(MdcFormatLineSpacing_1.default,{className:"bp4-icon",style:{fontSize:"20px"}}),minimal:!0})))),exports.DirectionInput=(0,mobx_react_lite_1.observer)((({element:e})=>{const t="rtl"===e.dir?MdFormatTextdirectionRToL_1.default:MdFormatTextdirectionLToR_1.default;return react_1.default.createElement(core_1.Button,{icon:react_1.default.createElement(t,{className:"bp4-icon",style:{fontSize:"20px"}}),minimal:!0,onClick:()=>{e.set({dir:"rtl"===e.dir?"ltr":"rtl"})}})}));const PROPS_MAP={TextFontFamily:exports.FontFamilyInput,TextFontSize:exports.FontSizeInput,TextFontVariant:exports.FontStyleGroup,TextFilters:filters_picker_1.default,TextFill:exports.FontColorInput,TextSpacing:exports.SpacingInput,TextDirection:exports.DirectionInput};exports.HtmlToolbar=(0,mobx_react_lite_1.observer)((({store:e,hideTextFontFamily:t,hideTextEffects:n,hideTextSpacing:l,hideTextBold:o,hideTextItalic:r,hideTextUnderline:i,components:a})=>{const c=e.selectedElements[0],u=["TextFill",!t&&"TextFontFamily","TextFontSize","TextFontVariant",!l&&"TextSpacing",!n&&"TextFilters"].filter((e=>!!e)),_=(0,element_container_1.extendToolbar)({type:"text",usedItems:u,components:a});return react_1.default.createElement(element_container_1.ElementContainer,{items:_,itemRender:t=>{const n=a[t]||PROPS_MAP[t];return react_1.default.createElement(n,{element:c,store:e,key:t,hideTextBold:o,hideTextItalic:r,hideTextUnderline:i})}})}));